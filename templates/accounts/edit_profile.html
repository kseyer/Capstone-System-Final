{% extends 'base.html' %}
{% load static %}

{% block title %}Edit Profile - Skinovation Beauty Clinic{% endblock %}

{% block extra_css %}
<style>
    :root {
        --primary-color: #6f42c1;
        --secondary-color: #8e44ad;
        --gradient-primary: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    }

    body {
        background: linear-gradient(135deg, #f8f9ff 0%, #e8e3ff 100%);
        background-attachment: fixed;
    }

    .edit-profile-container {
        min-height: 100vh;
        padding: 2rem 0;
    }

    .page-header {
        background: var(--gradient-primary);
        color: white;
        padding: 3rem 0;
        margin-bottom: 3rem;
        position: relative;
        overflow: hidden;
    }

    .profile-card {
        background: rgba(255, 255, 255, 0.95);
        backdrop-filter: blur(15px);
        border-radius: 20px;
        box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
        border: 1px solid rgba(255, 255, 255, 0.2);
        overflow: hidden;
    }

    .profile-picture-section {
        text-align: center;
        padding: 2rem;
        background: linear-gradient(135deg, #f8f9ff 0%, #e8e3ff 100%);
        border-bottom: 2px solid #e0e0e0;
    }

    .profile-picture-preview {
        width: 150px;
        height: 150px;
        border-radius: 50%;
        object-fit: cover;
        border: 4px solid var(--primary-color);
        box-shadow: 0 4px 15px rgba(0,0,0,0.2);
        margin-bottom: 1rem;
    }

    .profile-picture-placeholder {
        width: 150px;
        height: 150px;
        border-radius: 50%;
        background: var(--gradient-primary);
        color: white;
        display: inline-flex;
        align-items: center;
        justify-content: center;
        font-size: 3rem;
        border: 4px solid var(--primary-color);
        box-shadow: 0 4px 15px rgba(0,0,0,0.2);
        margin-bottom: 1rem;
    }

    .form-section {
        padding: 2rem;
    }

    .form-section h5 {
        color: var(--primary-color);
        font-weight: bold;
        margin-bottom: 1.5rem;
        padding-bottom: 0.5rem;
        border-bottom: 2px solid #e0e0e0;
    }

    .input-group .btn-outline-secondary {
        border-left: none;
        border-color: #ced4da;
    }

    .input-group .btn-outline-secondary:hover {
        background-color: #e9ecef;
        border-color: #ced4da;
    }

    .input-group .form-control:focus + .btn-outline-secondary,
    .input-group .form-control:focus ~ .btn-outline-secondary {
        border-color: #86b7fe;
        box-shadow: 0 0 0 0.25rem rgba(13, 110, 253, 0.25);
    }
</style>
{% endblock %}

{% block content %}
<div class="edit-profile-container">
    <!-- Page Header -->
    <div class="page-header">
        <div class="container text-center">
            <h1 class="display-4 fw-bold mb-3">
                <i class="fas fa-user-edit me-3"></i>Edit Profile
            </h1>
            <p class="lead">Update your account information</p>
        </div>
    </div>

    <div class="container">
        <div class="row">
            <div class="col-lg-10 mx-auto">
                <div class="profile-card">
                    <form method="post" enctype="multipart/form-data">
                        {% csrf_token %}
                        
                        <!-- Profile Picture Section -->
                        <div class="profile-picture-section">
                            {% if user.profile_picture %}
                                <img src="{{ user.profile_picture.url }}" alt="Current Profile Picture" class="profile-picture-preview" id="profilePreview">
                            {% else %}
                                <div class="profile-picture-placeholder" id="profilePreview">
                                    <i class="fas fa-user"></i>
                                </div>
                            {% endif %}
                            <div class="mb-3">
                                <label for="id_profile_picture" class="form-label fw-bold">Profile Picture</label>
                                <input type="file" class="form-control" id="id_profile_picture" name="profile_picture" accept="image/*" onchange="previewImage(this)">
                                <div class="form-text">Upload a profile picture (JPG or PNG format - Max 5MB)</div>
                            </div>
                        </div>

                        <div class="form-section">
                            <!-- Data Privacy Disclaimer -->
                            <div class="alert alert-info alert-dismissible fade show mb-4" role="alert">
                                <i class="fas fa-info-circle me-2"></i>
                                <strong>Data Privacy Notice:</strong> Your data will be used only for operational purposes and will be kept confidential. We are committed to protecting your personal information in accordance with data privacy regulations.
                                <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                            </div>
                            
                            {% if messages %}
                                {% for message in messages %}
                                    <div class="alert alert-{{ message.tags }} alert-dismissible fade show" role="alert">
                                        {{ message }}
                                        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                                    </div>
                                {% endfor %}
                            {% endif %}

                            {% if form.errors %}
                                <div class="alert alert-danger">
                                    <strong>Please correct the errors below:</strong>
                                    <ul class="mb-0 mt-2">
                                        {% for field, errors in form.errors.items %}
                                            {% for error in errors %}
                                                <li>{{ field|title }}: {{ error }}</li>
                                            {% endfor %}
                                        {% endfor %}
                                    </ul>
                                </div>
                            {% endif %}

                            <!-- Personal Information -->
                            <h5><i class="fas fa-user me-2"></i>Personal Information</h5>
                            <div class="row mb-4">
                                <div class="col-md-4 mb-3">
                                    <label for="id_first_name" class="form-label">First Name <span class="text-danger">*</span></label>
                                    {{ form.first_name }}
                                </div>
                                <div class="col-md-4 mb-3">
                                    <label for="id_middle_name" class="form-label">Middle Name</label>
                                    {{ form.middle_name }}
                                </div>
                                <div class="col-md-4 mb-3">
                                    <label for="id_last_name" class="form-label">Last Name <span class="text-danger">*</span></label>
                                    {{ form.last_name }}
                                </div>
                            </div>

                            <!-- Contact Information -->
                            <h5><i class="fas fa-envelope me-2"></i>Contact Information</h5>
                            <div class="row mb-4">
                                <div class="col-md-6 mb-3">
                                    <label for="id_email" class="form-label">Email <span class="text-danger">*</span></label>
                                    {{ form.email }}
                                </div>
                                <div class="col-md-6 mb-3">
                                    <label for="id_phone" class="form-label">Phone</label>
                                    <input type="tel" 
                                           class="form-control" 
                                           id="id_phone" 
                                           name="phone" 
                                           value="{{ form.phone.value|default:'' }}" 
                                           maxlength="11" 
                                           pattern="09[0-9]{9}"
                                           inputmode="numeric"
                                           placeholder="09123456789"
                                           oninput="formatPhilippinePhone(this)"
                                           onkeypress="return isNumberKey(event)">
                                    {% if form.phone.errors %}
                                        <div class="text-danger small">{{ form.phone.errors }}</div>
                                    {% endif %}
                                    <div class="form-text">Format: 09123456789 (Numbers only, must start with 09)</div>
                                </div>
                            </div>
                            <div class="row mb-4">
                                <div class="col-12 mb-3">
                                    <label for="id_address" class="form-label">Address</label>
                                    {{ form.address }}
                                </div>
                            </div>

                            <!-- Password Section -->
                            <h5><i class="fas fa-lock me-2"></i>Password Management</h5>
                            <div class="alert alert-info mb-3">
                                <i class="fas fa-info-circle me-2"></i>
                                <strong>Important:</strong> For security reasons, passwords are encrypted and cannot be displayed. If you forgot your password, enter it in the field below and click the verify button (‚úì) to check if it's correct. Use the eye icon (üëÅÔ∏è) to show/hide what you're typing. To change your password, enter your current password and then enter a new password.
                            </div>
                            <div class="row mb-4">
                                <div class="col-md-6 mb-3">
                                    <label for="id_current_password" class="form-label">Current Password</label>
                                    <div class="input-group">
                                        <input type="password" 
                                               class="form-control" 
                                               id="id_current_password" 
                                               name="current_password" 
                                               placeholder="Enter your current password"
                                               autocomplete="current-password">
                                        <button class="btn btn-outline-secondary" type="button" id="toggleCurrentPassword" onclick="togglePasswordVisibility('id_current_password', 'toggleCurrentPassword')">
                                            <i class="fas fa-eye" id="iconCurrentPassword"></i>
                                        </button>
                                        <button class="btn btn-outline-info" type="button" id="verifyPasswordBtn" onclick="verifyPassword()" title="Verify if your password is correct">
                                            <i class="fas fa-check"></i>
                                        </button>
                                    </div>
                                    <div id="passwordVerificationResult" class="mt-2"></div>
                                    {% if form.current_password.errors %}
                                        <div class="text-danger small">{{ form.current_password.errors }}</div>
                                    {% endif %}
                                    <div class="form-text">Enter your current password and click verify to check if it's correct</div>
                                </div>
                                <div class="col-md-6 mb-3">
                                    <label for="id_new_password" class="form-label">New Password</label>
                                    <div class="input-group">
                                        <input type="password" class="form-control" id="id_new_password" name="new_password" placeholder="Enter new password (optional)">
                                        <button class="btn btn-outline-secondary" type="button" id="toggleNewPassword" onclick="togglePasswordVisibility('id_new_password', 'toggleNewPassword')">
                                            <i class="fas fa-eye" id="iconNewPassword"></i>
                                        </button>
                                    </div>
                                    {% if form.new_password.errors %}
                                        <div class="text-danger small">{{ form.new_password.errors }}</div>
                                    {% endif %}
                                    <div class="form-text">Leave blank if you don't want to change your password</div>
                                </div>
                            </div>
                            <div class="row mb-4">
                                <div class="col-md-6 mb-3">
                                    <label for="id_confirm_password" class="form-label">Confirm New Password</label>
                                    <div class="input-group">
                                        <input type="password" class="form-control" id="id_confirm_password" name="confirm_password" placeholder="Confirm new password">
                                        <button class="btn btn-outline-secondary" type="button" id="toggleConfirmPassword" onclick="togglePasswordVisibility('id_confirm_password', 'toggleConfirmPassword')">
                                            <i class="fas fa-eye" id="iconConfirmPassword"></i>
                                        </button>
                                    </div>
                                    {% if form.confirm_password.errors %}
                                        <div class="text-danger small">{{ form.confirm_password.errors }}</div>
                                    {% endif %}
                                </div>
                            </div>

                            <!-- Additional Information -->
                            <h5><i class="fas fa-info-circle me-2"></i>Additional Information</h5>
                            <div class="row mb-4">
                                <div class="col-md-4 mb-3">
                                    <label for="id_gender" class="form-label">Gender</label>
                                    {{ form.gender }}
                                </div>
                                <div class="col-md-4 mb-3">
                                    <label for="id_civil_status" class="form-label">Civil Status</label>
                                    {{ form.civil_status }}
                                </div>
                                <div class="col-md-4 mb-3">
                                    <label for="id_birthday" class="form-label">Birthday</label>
                                    {{ form.birthday }}
                                </div>
                            </div>
                            <div class="row mb-4">
                                <div class="col-12 mb-3">
                                    <label for="id_occupation" class="form-label">Occupation</label>
                                    {{ form.occupation }}
                                </div>
                            </div>

                            <!-- Form Actions -->
                            <div class="d-flex justify-content-between mt-4 pt-4 border-top">
                                <a href="{% url 'accounts:profile' %}" class="btn btn-secondary">
                                    <i class="fas fa-arrow-left me-2"></i>Cancel
                                </a>
                                <button type="submit" class="btn btn-primary">
                                    <i class="fas fa-save me-2"></i>Save Changes
                                </button>
                            </div>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
function previewImage(input) {
    if (input.files && input.files[0]) {
        const reader = new FileReader();
        reader.onload = function(e) {
            const preview = document.getElementById('profilePreview');
            if (preview.tagName === 'IMG') {
                preview.src = e.target.result;
            } else {
                // Replace placeholder with image
                const img = document.createElement('img');
                img.src = e.target.result;
                img.className = 'profile-picture-preview';
                img.id = 'profilePreview';
                img.alt = 'Profile Picture Preview';
                preview.parentNode.replaceChild(img, preview);
            }
        };
        reader.readAsDataURL(input.files[0]);
    }
}

function isNumberKey(evt) {
    const charCode = (evt.which) ? evt.which : evt.keyCode;
    // Allow only numbers (0-9)
    if (charCode > 31 && (charCode < 48 || charCode > 57)) {
        return false;
    }
    return true;
}

function formatPhilippinePhone(input) {
    // Remove all non-numeric characters
    let value = input.value.replace(/[^0-9]/g, '');
    
    // Limit to 11 digits
    if (value.length > 11) {
        value = value.slice(0, 11);
    }
    
    // Ensure it starts with 09
    if (value.length > 0) {
        if (value.length === 1) {
            // If first digit is not 0, prepend 0
            if (value !== '0') {
                value = '0' + value;
            }
        } else if (value.length === 2) {
            // If second digit is not 9, replace with 09
            if (value[0] === '0' && value[1] !== '9') {
                value = '09';
            } else if (value[0] !== '0') {
                value = '09';
            }
        } else if (value.length > 2 && !value.startsWith('09')) {
            // If it doesn't start with 09, fix it
            if (value[0] === '0' && value[1] !== '9') {
                value = '09' + value.substring(2);
            } else {
                value = '09' + value.substring(value[0] === '0' ? 2 : 0);
            }
        }
    }
    
    input.value = value;
}

function togglePasswordVisibility(inputId, buttonId) {
    const input = document.getElementById(inputId);
    const button = document.getElementById(buttonId);
    const icon = button.querySelector('i');
    
    if (input.type === 'password') {
        input.type = 'text';
        icon.classList.remove('fa-eye');
        icon.classList.add('fa-eye-slash');
    } else {
        input.type = 'password';
        icon.classList.remove('fa-eye-slash');
        icon.classList.add('fa-eye');
    }
}

function verifyPassword() {
    const passwordInput = document.getElementById('id_current_password');
    const password = passwordInput.value;
    const resultDiv = document.getElementById('passwordVerificationResult');
    
    if (!password) {
        resultDiv.innerHTML = '<div class="alert alert-warning mb-0"><i class="fas fa-exclamation-triangle me-2"></i>Please enter your password to verify</div>';
        return;
    }
    
    // Get CSRF token
    const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]')?.value || 
                      document.cookie.match(/csrftoken=([^;]+)/)?.[1];
    
    // Verify password via AJAX
    fetch('{% url "accounts:verify_password" %}', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': csrfToken || '',
        },
        body: JSON.stringify({ password: password })
    })
    .then(response => response.json())
    .then(data => {
        if (data.valid) {
            resultDiv.innerHTML = '<div class="alert alert-success mb-0"><i class="fas fa-check-circle me-2"></i>Password is correct!</div>';
        } else {
            resultDiv.innerHTML = '<div class="alert alert-danger mb-0"><i class="fas fa-times-circle me-2"></i>Password is incorrect. Please try again.</div>';
        }
    })
    .catch(error => {
        console.error('Error:', error);
        resultDiv.innerHTML = '<div class="alert alert-danger mb-0"><i class="fas fa-exclamation-triangle me-2"></i>Error verifying password. Please try again.</div>';
    });
}
</script>
{% endblock %}

