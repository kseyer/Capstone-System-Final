{% extends 'owner/base.html' %}
{% load static %}

{% block title %}Database Backup Management{% endblock %}

{% block page_title %}Database Backup{% endblock %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-4">
    <div>
        <h3 class="mb-2">
            <i class="fas fa-database me-2" style="background: var(--gradient-primary); -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text;"></i>
            Database Backup Management
        </h3>
        <p class="text-muted mb-0">Create, download, and manage database backups</p>
    </div>
    <a href="{% url 'owner:dashboard' %}" class="btn btn-secondary">
        <i class="fas fa-arrow-left me-2"></i> Back to Dashboard
    </a>
</div>

<!-- Database Information Card -->
<div class="card mb-4">
    <div class="card-header">
        <h5 class="mb-0">
            <i class="fas fa-info-circle me-2"></i>Database Information
        </h5>
    </div>
    <div class="card-body">
        <div class="row">
            <div class="col-md-6">
                <p><strong>Database Engine:</strong> {{ db_engine|title }}</p>
                <p><strong>Database Name:</strong> {{ db_name }}</p>
            </div>
            <div class="col-md-6">
                <p><strong>Total Backups:</strong> {{ backup_count }}</p>
                <p><strong>Backup Directory:</strong> <code>{{ backup_dir }}</code></p>
            </div>
        </div>
    </div>
</div>

<!-- Create Backup Card -->
<div class="card mb-4">
    <div class="card-header">
        <h5 class="mb-0">
            <i class="fas fa-plus-circle me-2"></i>Create New Backup
        </h5>
    </div>
    <div class="card-body">
        <form method="post">
            {% csrf_token %}
            <div class="mb-3">
                <div class="form-check">
                    <input class="form-check-input" type="checkbox" id="compress" name="compress">
                    <label class="form-check-label" for="compress">
                        <i class="fas fa-compress me-2"></i>Compress backup (saves disk space)
                    </label>
                </div>
            </div>
            <button type="submit" name="create_backup" class="btn btn-primary">
                <i class="fas fa-database me-2"></i>Create Backup Now
            </button>
        </form>
        <div class="alert alert-info mt-3 mb-0">
            <i class="fas fa-info-circle me-2"></i>
            <strong>Note:</strong> Creating a backup may take a few moments depending on your database size. 
            The system will automatically keep the 10 most recent backups.
        </div>
    </div>
</div>

<!-- Backup List Card -->
<div class="card">
    <div class="card-header">
        <h5 class="mb-0">
            <i class="fas fa-list me-2"></i>Available Backups
        </h5>
    </div>
    <div class="card-body">
        {% if backup_files %}
            <div class="table-responsive">
                <table class="table">
                    <thead>
                        <tr>
                            <th><i class="fas fa-file me-2"></i>Filename</th>
                            <th><i class="fas fa-hdd me-2"></i>Size</th>
                            <th><i class="fas fa-calendar me-2"></i>Created</th>
                            <th><i class="fas fa-cog me-2"></i>Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for backup in backup_files %}
                        <tr>
                            <td>
                                <div class="d-flex align-items-center">
                                    {% if backup.is_compressed %}
                                        <i class="fas fa-file-archive text-warning me-2"></i>
                                    {% else %}
                                        <i class="fas fa-database text-primary me-2"></i>
                                    {% endif %}
                                    <code>{{ backup.filename }}</code>
                                </div>
                            </td>
                            <td>{{ backup.size_mb }} MB</td>
                            <td>{{ backup.created|date:"M d, Y H:i" }}</td>
                            <td>
                                <div class="btn-group" role="group">
                                    <a href="{% url 'owner:download_backup' backup.filename %}" class="btn btn-sm btn-success" title="Download">
                                        <i class="fas fa-download"></i> Download
                                    </a>
                                    <form method="post" style="display: inline;" onsubmit="return confirm('Are you sure you want to delete this backup? This action cannot be undone.');">
                                        {% csrf_token %}
                                        <input type="hidden" name="backup_filename" value="{{ backup.filename }}">
                                        <button type="submit" name="delete_backup" class="btn btn-sm btn-danger" title="Delete">
                                            <i class="fas fa-trash"></i> Delete
                                        </button>
                                    </form>
                                </div>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        {% else %}
            <div class="text-center py-5">
                <i class="fas fa-database fa-3x text-muted mb-3"></i>
                <h5 class="text-muted">No backups found</h5>
                <p class="text-muted">Create your first backup using the form above.</p>
            </div>
        {% endif %}
    </div>
</div>

<!-- Instructions Card -->
<div class="card mt-4">
    <div class="card-header">
        <h5 class="mb-0">
            <i class="fas fa-question-circle me-2"></i>How to Use
        </h5>
    </div>
    <div class="card-body">
        <h6><i class="fas fa-database me-2"></i>Creating Backups</h6>
        <ul>
            <li>Click "Create Backup Now" to create a new database backup</li>
            <li>Enable compression to save disk space (recommended for large databases)</li>
            <li>Backups are automatically timestamped for easy identification</li>
        </ul>
        
        <h6 class="mt-3"><i class="fas fa-download me-2"></i>Downloading Backups</h6>
        <ul>
            <li>Click the "Download" button next to any backup to save it to your computer</li>
            <li>Keep backups in a safe location separate from your server</li>
            <li>Regular backups are essential for disaster recovery</li>
        </ul>
        
        <h6 class="mt-3"><i class="fas fa-cog me-2"></i>Command Line Usage</h6>
        <p>You can also create backups from the command line:</p>
        <pre class="bg-light p-3 rounded"><code># Basic backup
python manage.py backup_database

# Compressed backup
python manage.py backup_database --compress

# Custom output directory
python manage.py backup_database --output-dir /path/to/backups

# Keep more backups
python manage.py backup_database --keep 20</code></pre>
        
        <h6 class="mt-3"><i class="fas fa-shield-alt me-2"></i>Best Practices</h6>
        <ul>
            <li>Create backups before major updates or changes</li>
            <li>Store backups in multiple locations (local, cloud, external drive)</li>
            <li>Test backup restoration periodically</li>
            <li>Keep backups for at least 30 days</li>
            <li>Automate backups using cron jobs or scheduled tasks</li>
        </ul>
    </div>
</div>

<style>
pre code {
    font-size: 0.9rem;
}
</style>
{% endblock %}

